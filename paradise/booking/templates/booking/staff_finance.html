{% extends "admin/base_site.html" %}

{% block content %}
<div class="container py-4" style="max-width: 1200px;">
  <h2 class="mb-3">Finance Dashboard</h2>

  <form method="get" class="row g-2 mb-3">
    <div class="col-md-3">
      <label class="form-label">Start</label>
      <input type="date" name="start" value="{{ start|date:'Y-m-d' }}" class="form-control">
    </div>
    <div class="col-md-3">
      <label class="form-label">End</label>
      <input type="date" name="end" value="{{ end|date:'Y-m-d' }}" class="form-control">
    </div>
    <div class="col-md-3">
      <label class="form-label">Payment status</label>
      <select name="payment_status" class="form-select">
        <option value="" {% if not filter_payment_status %}selected{% endif %}>All</option>
        <option value="unpaid" {% if filter_payment_status == 'unpaid' %}selected{% endif %}>Unpaid</option>
        <option value="paid" {% if filter_payment_status == 'paid' %}selected{% endif %}>Paid</option>
        <option value="refunded" {% if filter_payment_status == 'refunded' %}selected{% endif %}>Refunded</option>
      </select>
    </div>
    <div class="col-md-3 d-flex align-items-end gap-2">
      <button class="btn btn-primary">Apply</button>
      <a class="btn btn-outline-secondary"
         href="{% url 'finance_csv' %}?start={{ start|date:'Y-m-d' }}&end={{ end|date:'Y-m-d' }}{% if filter_payment_status %}&payment_status={{ filter_payment_status }}{% endif %}">
        Export CSV
      </a>
    </div>
  </form>

  <div class="row g-3 mb-4">
    <div class="col-md-3">
      <div class="p-3 border rounded bg-light">
        <div class="small text-muted">Total Revenue (paid)</div>
        <div class="fs-4 fw-bold">${{ total_paid }}</div>
      </div>
    </div>
    <div class="col-md-3">
      <div class="p-3 border rounded bg-light">
        <div class="small text-muted">Paid Bookings</div>
        <div class="fs-4 fw-bold">{{ total_paid_count }}</div>
      </div>
    </div>
    <div class="col-md-3">
      <div class="p-3 border rounded bg-light">
        <div class="small text-muted">Unpaid Bookings</div>
        <div class="fs-4 fw-bold">{{ total_unpaid_count }}</div>
      </div>
    </div>
    <div class="col-md-3">
      <div class="p-3 border rounded bg-light">
        <div class="small text-muted">Refunded Bookings</div>
        <div class="fs-4 fw-bold">{{ total_refunded_count }}</div>
      </div>
    </div>
  </div>

  <h5 class="mt-4">Daily Paid Revenue</h5>
  <div class="table-responsive mb-4">
    <table class="table table-sm table-striped">
      <thead>
        <tr><th>Date</th><th>Count</th><th>Amount ($)</th></tr>
      </thead>
      <tbody>
        {% for d in daily %}
          <tr>
            <td>{{ d.payment_date }}</td>
            <td>{{ d.count }}</td>
            <td>{{ d.amount }}</td>
          </tr>
        {% empty %}
          <tr><td colspan="3" class="text-center">No paid bookings in this period.</td></tr>
        {% endfor %}
      </tbody>
    </table>
  </div>

  <h5>Recent Bookings (filtered)</h5>
  <div class="table-responsive">
    <table class="table table-sm table-hover">
      <thead>
        <tr>
          <th>Invoice #</th>
          <th>Customer</th>
          <th>Room</th>
          <th>Status</th>
          <th>Payment</th>
          <th>Amount</th>
          <th>Created</th>
        </tr>
      </thead>
      <tbody>
        {% for b in rows %}
          <tr>
            <td>{{ b.invoice_number }}</td>
            <td>{{ b.customer_name }}</td>
            <td>Room {{ b.room.room_number }} ({{ b.room.room_type }})</td>
            <td>{{ b.status|title }}</td>
            <td>{{ b.payment_status|title }}</td>
            <td>${{ b.amount_paid|default:"0.00" }}</td>
            <td>{{ b.created_at|date:"Y-m-d H:i" }}</td>
          </tr>
        {% empty %}
          <tr><td colspan="7" class="text-center">No bookings.</td></tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</div>
{% endblock %}
